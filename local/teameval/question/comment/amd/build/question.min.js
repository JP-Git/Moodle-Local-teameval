define(["jquery","local_teameval/question","core/templates","core/notification","core/str","local_teameval/formparse","local_teameval/editor"],function(a,b,c,d,e,f,g){function h(a,c,d,e,f,g,h,i){b.apply(this,arguments),this._self=e,this._editing=f,i=i||{},this._editingcontext=i.editingcontext||{_newquestion:!0},this._editinglocked=i.editinglocked||!1,this._submissioncontext=i.submissioncontext||{},this.pluginName="comment"}return h.prototype=new b,h.prototype.submissionContext=function(){return this._submissioncontext},h.prototype.submissionView=function(){return b.prototype.submissionView.apply(this,arguments)},h.prototype.editingContext=function(){return this._editingcontext},h.prototype.editingView=function(){return this.editForm("\\teamevalquestion_comment\\forms\\edit_form",a.param(this._editingcontext),{locked:this._editinglocked})},h.prototype.save=function(b){var c=this.container.find("form");g.saveAll(c);var d=f.serializeObject(c),h=this.saveForm(c,b),i=e.get_strings([{key:"exampleuser",component:"local_teameval"},{key:"yourself",component:"local_teameval"}]);return a.when(h,i).then(function(b,e){var g=[{userid:0,name:e[0]}];return this._self&&g.unshift({userid:-1,name:e[1],self:!0}),this._submissioncontext=a.extend({},f.serializeObject(c,{fixCheckboxes:!0}),{users:g}),this._submissioncontext.description=d.description.text,this._editingcontext=d,b}.bind(this))},h.prototype.validateData=function(b){var c=a.Deferred(),d=function(c){return a(b).find('[name="'+c+'"]').val()};return 0===d("title").trim().length&&0===d("description").trim().length?e.get_string("titleordescription","teamevalquestion_comment").done(function(a){c.reject({invalid:!0,errors:{title:a,description:a}})}):c.resolve(),c.promise()},h.prototype.submit=function(b){var c=[];this.container.find(".comments textarea").each(function(){var b=a(this).data("touser"),d={};d.touser=b,d.comment=a(this).val(),c.push(d)}),b({methodname:"teamevalquestion_comment_submit_response",args:{teamevalid:this.teameval,id:this.questionID,comments:c}});var d=!1;return this._submissioncontext.optional||(d=this.checkComplete()),!d},h.prototype.checkComplete=function(){var b=this.container.find("textarea").filter(function(){return 0===a(this).val().trim().length});return b.length>0?this.container.parent().addClass("incomplete"):this.container.parent().removeClass("incomplete"),b.length>0},h});