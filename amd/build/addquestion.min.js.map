{"version":3,"sources":["../src/addquestion.js"],"names":["define","$","ui","str","templates","ajax","notification","_id","_contextid","_subplugins","_self","_locked","_addButton","_searchBar","_initialised","_templateAddButton","_templatePreviewFunction","preAddQuestion","evt","dropdown","each","name","subplugin","li","html","displayname","data","append","coords","position","css","top","stopPropagation","_this","document","one","target","closest","length","type","addQuestion","done","question","editQuestion","remove","questionID","context","questionContainer","addEditingControls","d","Deferred","require","QuestionClass","qObject","resolve","promise","render","locked","actionBar","prepend","find","click","deleteQuestion","hasClass","hide","buttonArea","saveQuestion","showQuestion","questionObject","editingView","addClass","show","fail","ordinal","index","save","bind","submissionView","removeClass","exception","removeData","delete","setOrder","order","map","i","el","id","filter","get","promises","call","methodname","args","addFromTemplate","templateid","prop","from","to","questions","addQuestions","val","qdata","questionid","JSON","parse","initialised","initialise","options","contextid","self","subplugins","addButton","templateSearch","templateIO","window","location","href","download","sortable","handle","axis","update","templatePreviewFunction","autocomplete","minLength","source","request","response","term","results","focus","event","item","title","select","_renderItem","autocompleteRenderFunction","instance","M","core_filepicker","instances","filepickerid","formcallback","file","filepickeritemid"],"mappings":"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","sourcesContent":["/*\n * @package    local_teameval\n * @copyright  2015 Morgan Harris\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n /**\n  * Add question button for teameval blocks\n  * @module local_teameval/addquestion\n  */\ndefine(['jquery', 'jqueryui', 'core/str', 'core/templates', 'core/ajax', 'core/notification'],\n    function($, ui, str, templates, ajax, notification) {\n\n    \"use strict\";\n\n    var _id;\n\n    var _contextid;\n\n    var _subplugins;\n\n    var _self;\n\n    var _locked;\n\n    var _addButton;\n\n    var _searchBar;\n\n    var _initialised;\n\n    var _templateAddButton;\n\n    var _templatePreviewFunction; // called with no args to reset\n\n    return {\n\n        // Ask the user what kind of question they want to add\n        preAddQuestion: function(evt) {\n\n            //todo: check that you CAN add a question right now\n\n            //todo: if there's only one question subplugin skip this step and assume they mean that\n\n            //todo: mustache this\n            var dropdown = $('<ul class=\"local-teameval-question-dropdown\" />');\n            $.each(_subplugins, function(name, subplugin) {\n                var li = $(\"<li />\");\n                li.html('<a>' + subplugin.displayname + '</a>');\n                li.data('type',subplugin.name);\n                dropdown.append(li);\n            });\n\n            $(\".local-teameval-containerbox\").append(dropdown);\n            var coords = _addButton.position();\n\n            dropdown.css('top', coords.top + 'px');\n            dropdown.css('right', '0px');\n\n            // If we don't do this, we'll accidentally trigger our click-outside handler\n            evt.stopPropagation();\n\n            var _this = this;\n            $(document).one('click', function(evt) {\n                if ($(evt.target).closest('.local-teameval-question-dropdown').length > 0) {\n                    var type = $(evt.target).closest('li').data('type');\n                    _this.addQuestion(type).done(function(question) {\n                        _this.editQuestion(question);\n                    });\n                }\n                dropdown.remove();\n            });\n\n        },\n\n        addQuestion: function(type, questionID, context) {\n            var question = $('<li class=\"local-teameval-question\" />');\n            var questionContainer = $('<div class=\"question-container\" />');\n            question.append(questionContainer);\n            $('#local-teameval-questions').append(question);\n            this.addEditingControls(question);\n\n            question.data('questiontype', type);\n            if (questionID) {\n                question.data('questionid', questionID);\n            }\n\n            var d = $.Deferred();\n            require(['teamevalquestion_'+type+'/question'], function(QuestionClass) {\n                var qObject = new QuestionClass(questionContainer, _id, _contextid, _self, true, false, questionID, context);\n                questionContainer.data(\"question\", qObject);\n                d.resolve(question);\n            });\n\n            return d.promise();\n        },\n\n        addEditingControls: function(question) {\n            var _this = this;\n\n            templates.render('local_teameval/question_actions', {locked:_locked}).done(function(html) {\n\n                var actionBar = $(html);\n                question.prepend(actionBar);\n                actionBar.find('.edit').click(function() {\n                    _this.editQuestion(question);\n                });\n                actionBar.find('.delete').click(function() {\n                    _this.deleteQuestion(question);\n                });\n\n\n                //if we're in editing mode, hide the edit and delete buttons\n                if (question.hasClass('editing')) {\n                    actionBar.hide();\n                }\n\n            });\n\n            // and our Save and Cancel buttons for editing\n\n            templates.render('local_teameval/save_cancel_buttons', {}).done(function(html) {\n                var buttonArea = $(html);\n                buttonArea.find(\".save\").click(function() {\n                    _this.saveQuestion(question);\n                });\n                buttonArea.find(\".cancel\").click(function() {\n                    // The cancel button should delete a question if it isn't saved\n                    if (question.data('questionid') === undefined) {\n                        _this.deleteQuestion(question);\n                    } else {\n                        _this.showQuestion(question);\n                    }\n                });\n                question.append(buttonArea);\n\n                if (!question.hasClass('editing')) {\n                    buttonArea.hide();\n                }\n\n            });\n        },\n\n        editQuestion: function(question) {\n\n            // hide the action bar\n            question.find('.local-teameval-question-actions').hide();\n            var questionContainer = question.find('.question-container');\n\n            var questionObject = questionContainer.data(\"question\");\n\n            questionObject.editingView().done(function() {\n\n                question.addClass('editing');\n                question.find('.local-teameval-save-cancel-buttons').show();\n\n            }).fail(function () {\n\n                question.find('.local-teameval-question-actions').show();\n\n            });\n\n        },\n\n        saveQuestion: function(question) {\n\n            // todo: do save\n\n            var questionContainer = question.find('.question-container');\n            var questionObject = questionContainer.data(\"question\");\n            var ordinal = question.index('.local-teameval-question');\n            var promise = questionObject.save(ordinal);\n            promise.done(function(questionID) {\n                question.data('questionid', questionID);\n                this.showQuestion(question);\n            }.bind(this));\n            promise.fail(function() {\n                // at the moment, do nothing\n                // rely on the question plugin to relay that saving has failed\n            }.bind(this));\n\n        },\n\n        showQuestion: function(question) {\n\n            var questionContainer = question.find('.question-container');\n            var questionObject = questionContainer.data('question');\n\n            questionObject.submissionView().done(function() {\n\n                question.removeClass('editing');\n\n                question.find('.local-teameval-save-cancel-buttons').hide();\n                question.find('.local-teameval-question-actions').show();\n\n            }).fail(notification.exception);\n\n        },\n\n        deleteQuestion: function(question) {\n            var questionContainer = question.find('.question-container');\n            if (question.data('questionid') === undefined) {\n                // just pull it out of the DOM\n                questionContainer.removeData('question');\n                question.remove();\n            } else {\n                // actually delete it from the database\n                var questionObject = questionContainer.data('question');\n                questionObject.delete().done(function() {\n                    questionContainer.removeData('question');\n                    question.remove();\n                }).fail(notification.exception);\n            }\n        },\n\n        setOrder: function() {\n            var order = $(\"#local-teameval-questions li\").map(function(i, el) {\n                return {type: $(el).data('questiontype'), id: $(el).data('questionid')};\n            }).filter(function(i, el) {\n                return ((el !== undefined) && (el.type !== undefined) && (el.id !== undefined));\n            }).get();\n\n            var promises = ajax.call([{\n                methodname: 'local_teameval_questionnaire_set_order',\n                args: {\n                    id: _id,\n                    order: order\n                }\n            }]);\n\n            promises[0].done(function() {\n\n            }).fail(notification.exception);\n        },\n\n        addFromTemplate: function() {\n            var templateid = _searchBar.data('template-id');\n\n            if (templateid > 0) {\n\n                _templateAddButton.prop('disabled', true);\n\n                var _this = this;\n\n                var promises = ajax.call([{\n                    methodname: 'local_teameval_add_from_template',\n                    args: {\n                        from: templateid,\n                        to: _id\n                    }\n                }]);\n\n                promises[0].done(function(questions) {\n                    _this.addQuestions(questions);\n\n                    //reset the view\n                    _templatePreviewFunction();\n                    _searchBar.val('');\n                });\n\n                promises[0].fail(notification.exception);\n            }\n        },\n\n        addQuestions: function(questions) {\n            for (var i = 0; i < questions.length; i++) {\n                var qdata = questions[i];\n                this.addQuestion(qdata.type, qdata.questionid, JSON.parse(qdata.context))\n                .done(function(question) {\n                    this.showQuestion(question);\n                }.bind(this));\n            }\n        },\n\n        // This might seem like a bit of a weird thing to put here\n        // but it's to avoid a race condition in dependent modules\n        // We only initialise once, after all.\n        initialised: function() {\n            if (!_initialised) {\n                _initialised = $.Deferred();\n            }\n            return _initialised.promise();\n        },\n\n        initialise: function(options) {\n\n            // available options\n            // containers: addButton, templateSearch, templateIO\n            // settings: id, self, locked, download, filepickerid, filepickeritemid, subplugins\n\n            _id = options.id;\n            _contextid = options.contextid;\n            _self = options.self;\n            _locked = options.locked;\n            _subplugins = options.subplugins;\n            _addButton = $(options.addButton);\n\n            // some locals. some of these might not be set.\n\n            var templateSearch = $(options.templateSearch);\n            var templateIO = $(options.templateIO);\n\n            // stupid javascript scoping\n\n            var _this = this;\n\n            // add the controls to the questions already in the block\n\n            $('#local-teameval-questions .local-teameval-question').each(function(i, el) {\n                _this.addEditingControls($(el));\n            });\n\n            templateIO.find('.template-download').click(function() {\n                window.location.href = options.download;\n            });\n\n            if (!_locked) {\n\n                $('#local-teameval-questions').sortable({\n                    handle: '.local-teameval-question-actions .move',\n                    axis: \"y\",\n                    update: function() {\n                        _this.setOrder();\n                    }\n                });\n\n                _addButton.find('a').click(_this.preAddQuestion.bind(_this));\n\n                // SET UP SEARCH BAR\n\n                _templateAddButton = templateSearch.find('button');\n                _templateAddButton.click(_this.addFromTemplate.bind(_this));\n                _templateAddButton.prop('disabled', true);\n\n                _templatePreviewFunction = options.templatePreviewFunction;\n\n                _searchBar = templateSearch.find('input');\n                _searchBar.autocomplete({\n                    minLength: 2,\n                    source: function(request, response) {\n                        var promises = ajax.call([{\n                            methodname: 'local_teameval_template_search',\n                            args: {\n                                id: _id,\n                                term: request.term\n                            }\n                        }]);\n\n                        promises[0].done(function(results) {\n                            response(results);\n                        });\n\n                        promises[0].fail(notification.exception);\n                    },\n                    focus: function( event, ui ) {\n                        _searchBar.val( ui.item.title );\n                        return false;\n                      },\n                    select: function( event, ui ) {\n                        if (ui.item) {\n                            _searchBar.val( ui.item.title );\n                            _searchBar.data('template-id', ui.item.id);\n                            _templateAddButton.prop('disabled', false);\n                            _templatePreviewFunction(ui.item);\n                        } else {\n                            _templateAddButton.prop('disabled', true);\n                            _templatePreviewFunction();\n                        }\n                        return false;\n                      }\n                });\n\n                _searchBar.focus(function() {\n                    _searchBar.val('');\n                    _templateAddButton.prop('disabled', true);\n                    _templatePreviewFunction();\n                });\n\n                _searchBar.autocomplete( \"instance\" )._renderItem = options.autocompleteRenderFunction;\n\n                // SET UP TEMPLATE DOWNLOAD\n\n                templateIO.find('.template-upload').click(function() {\n                    var instance = M.core_filepicker.instances[options.filepickerid];\n                    instance.options.formcallback = function(file) {\n                        var promises = ajax.call([{\n                            methodname: 'local_teameval_upload_template',\n                            args: {\n                                'id': _id,\n                                'itemid': options.filepickeritemid,\n                                'file': file.file,\n                            }\n                        }]);\n\n\n                        promises[0].done(function(questions) {\n                            _this.initialised().done(function() {\n                                _this.addQuestions(questions);\n                            });\n                        });\n\n                        promises[0].fail(notification.exception);\n                    };\n\n                    instance.show();\n                });\n\n                // FIRE INITIALISED\n                if (!_initialised) {\n                    _initialised = $.Deferred();\n                }\n                _initialised.resolve();\n\n\n            }\n\n        }\n\n    };\n\n});\n"],"file":"addquestion.min.js"}