{"version":3,"sources":["../src/submitquestion.js"],"names":["define","$","Templates","Ajax","Notification","Str","_cmid","submit","incompletes","prop","questions","find","map","data","sort","a","b","parseInt","optional","questionPromises","p","Deferred","complete","args","d","methodname","resolve","question","ajaxCall","deferred","promise","when","apply","done","slice","call","arguments","filter","v","allDone","push","cmid","promises","i","length","fail","reject","progress","notify","allPromises","always","key","get_string","string","text","show","hide","delay","exception","reset","initialise","render","html","js","questionContainer","append","runTemplateJS","click","bind"],"mappings":"AAUAA,OAAM,iCAAC,CAAC,QAAD,CAAW,gBAAX,CAA6B,WAA7B,CAA0C,mBAA1C,CAA+D,UAA/D,CAAD,CAA6E,SAASC,CAAT,CAAYC,CAAZ,CAAuBC,CAAvB,CAA6BC,CAA7B,CAA2CC,CAA3C,CAAgD,CAE/H,GAAIC,CAAAA,CAAJ,CAEA,MAAO,CAEHC,MAAM,CAAE,iBAAW,CAEf,GAAIC,CAAAA,CAAW,CAAG,CAAlB,CAEAP,CAAC,CAAC,wCAAD,CAAD,CAA4CQ,IAA5C,CAAiD,UAAjD,KAIA,GAAIC,CAAAA,CAAS,CAAGT,CAAC,CAAC,2BAAD,CAAD,CAA+BU,IAA/B,CAAoC,qBAApC,EAA2DC,GAA3D,CAA+D,UAAW,CACtF,MAAOX,CAAAA,CAAC,CAAC,IAAD,CAAD,CAAQY,IAAR,CAAa,UAAb,CACV,CAFe,CAAhB,CAKAH,CAAS,CAACI,IAAV,CAAe,SAASC,CAAT,CAAYC,CAAZ,CAAe,CAC1B,MAAOC,CAAAA,QAAQ,CAACD,CAAC,CAACE,QAAH,CAAR,CAAuBD,QAAQ,CAACF,CAAC,CAACG,QAAH,CACzC,CAFD,EAIA,GAAIC,CAAAA,CAAgB,CAAGT,CAAS,CAACE,GAAV,CAAc,UAAW,IACxCQ,CAAAA,CAAC,CAAGnB,CAAC,CAACoB,QAAF,EADoC,CAGxCC,CAAQ,CAAG,KAAKf,MAAL,CAAY,SAASgB,CAAT,CAAe,CACtC,GAAIC,CAAAA,CAAC,CAAGvB,CAAC,CAACoB,QAAF,EAAR,CAEA,GAAIE,CAAI,EAAIA,CAAI,CAACE,UAAjB,CAA6B,CACzBL,CAAC,CAACM,OAAF,CAAU,CACNC,QAAQ,CAAE,IADJ,CAENC,QAAQ,CAAEL,CAFJ,CAGNM,QAAQ,CAAEL,CAHJ,CAAV,CAKH,CAND,IAMO,CACHJ,CAAC,CAACM,OAAF,GACAF,CAAC,CAACE,OAAF,EACH,CAED,MAAOF,CAAAA,CAAC,CAACM,OAAF,EACV,CAfc,CAH6B,CAoB5C,GAAI,CAAER,CAAN,CAAgB,CACZd,CAAW,EACd,CAED,MAAOY,CAAAA,CAEV,CA1BsB,CAAvB,CA4BAnB,CAAC,CAAC8B,IAAF,CAAOC,KAAP,CAAa/B,CAAb,CAAgBkB,CAAhB,EAAkCc,IAAlC,CAAuC,UAAW,IAE1CvB,CAAAA,CAAS,CAAG,GAAGwB,KAAH,CAASC,IAAT,CAAcC,SAAd,EAAyBC,MAAzB,CAAgC,SAASC,CAAT,CAAY,CAAE,MAAOA,CAAAA,CAAC,SAAiB,CAAvE,CAF8B,CAK1CC,CAAO,CAAGtC,CAAC,CAACoB,QAAF,EALgC,CAM9CX,CAAS,CAAC8B,IAAV,CAAe,CACXZ,QAAQ,CAAE,CACNH,UAAU,CAAE,wCADN,CAENF,IAAI,CAAE,CACFkB,IAAI,CAAEnC,CADJ,CAFA,CADC,CAOXuB,QAAQ,CAAEU,CAPC,CAAf,EAYA,OAFIG,CAAAA,CAAQ,CAAGvC,CAAI,CAACgC,IAAL,CAAUzB,CAAS,CAACE,GAAV,CAAc,SAAS0B,CAAT,CAAY,CAAE,MAAOA,CAAAA,CAAC,CAACV,QAAW,CAAhD,CAAV,CAEf,CAASe,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAGjC,CAAS,CAACkC,MAA9B,CAAsCD,CAAC,EAAvC,CAA2C,IACnCvB,CAAAA,CAAC,CAAGsB,CAAQ,CAACC,CAAD,CADuB,CAEnCnB,CAAC,CAAGd,CAAS,CAACiC,CAAD,CAAT,CAAad,QAFkB,CAGvCT,CAAC,CAACa,IAAF,CAAOT,CAAC,CAACE,OAAT,EACAN,CAAC,CAACyB,IAAF,CAAOrB,CAAC,CAACsB,MAAT,EACA1B,CAAC,CAAC2B,QAAF,CAAWvB,CAAC,CAACwB,MAAb,CACH,CAED,GAAIC,CAAAA,CAAW,CAAGhD,CAAC,CAAC8B,IAAF,CAAOC,KAAP,CAAa/B,CAAb,CAAgByC,CAAhB,CAAlB,CACAO,CAAW,CAACC,MAAZ,CAAmB,UAAW,CAC1BjD,CAAC,CAAC,wCAAD,CAAD,CAA4CQ,IAA5C,CAAiD,UAAjD,IACH,CAFD,EAEGwB,IAFH,CAEQ,UAAW,CACf,GAAkB,CAAd,CAAAzB,CAAJ,CAAqB,CACjB,GAAI2C,CAAAA,CAAG,CAAkB,CAAf,EAAA3C,CAAW,CAAQ,oBAAR,CAA+B,mBAApD,CACAH,CAAG,CAAC+C,UAAJ,CAAeD,CAAf,CAAoB,gBAApB,CAAsC3C,CAAtC,EACKyB,IADL,CACU,SAASoB,CAAT,CAAiB,CACvBpD,CAAC,CAAC,oDAAD,CAAD,CAAwDqD,IAAxD,CAA6DD,CAA7D,EAAqEE,IAArE,CAA0E,MAA1E,CACH,CAHD,CAIH,CAND,IAMO,CACHtD,CAAC,CAAC,oDAAD,CAAD,CAAwDuD,IAAxD,CAA6D,MAA7D,EACAvD,CAAC,CAAC,+CAAD,CAAD,CAAmDsD,IAAnD,CAAwD,MAAxD,EAAgEE,KAAhE,CAAsE,GAAtE,EAA4ED,IAA5E,CAAiF,MAAjF,CACH,CACJ,CAbD,EAaGX,IAbH,CAaQzC,CAAY,CAACsD,SAbrB,CAeH,CA1CD,CA4CH,CA3FE,CA6FHC,KAAK,CAAE,gBAAW,CACd,GAAIjD,CAAAA,CAAS,CAAGT,CAAC,CAAC,2BAAD,CAAD,CAA+BU,IAA/B,CAAoC,qBAApC,EAA2DC,GAA3D,CAA+D,UAAW,CACtF,MAAOX,CAAAA,CAAC,CAAC,IAAD,CAAD,CAAQY,IAAR,CAAa,UAAb,CACV,CAFe,CAAhB,CAIAZ,CAAC,CAAC8B,IAAF,CAAOrB,CAAS,CAACE,GAAV,CAAc,UAAW,CAAE,MAAO,MAAK+C,KAAL,EAAe,CAAjD,CAAP,EACC1B,IADD,CACM,UAAW,CAEhB,CAHD,EAICY,IAJD,CAIMzC,CAAY,CAACsD,SAJnB,CAKH,CAvGE,CAyGHE,UAAU,CAAE,oBAASnB,CAAT,CAAe,CAEvBnC,CAAK,CAAGmC,CAAR,CAEAvC,CAAS,CAAC2D,MAAV,CAAiB,+BAAjB,CAAkD,EAAlD,EAAsD5B,IAAtD,CAA2D,SAAS6B,CAAT,CAAeC,CAAf,CAAmB,CAC1E,GAAIC,CAAAA,CAAiB,CAAG/D,CAAC,CAAC,8BAAD,CAAzB,CACA+D,CAAiB,CAACC,MAAlB,CAAyBH,CAAzB,EACA5D,CAAS,CAACgE,aAAV,CAAwBH,CAAxB,EAEA9D,CAAC,CAAC,wCAAD,CAAD,CAA4CkE,KAA5C,CAAkD,KAAK5D,MAAvD,EACAN,CAAC,CAAC,uCAAD,CAAD,CAA2CkE,KAA3C,CAAiD,KAAKR,KAAtD,CACH,CAP0D,CAOzDS,IAPyD,CAOpD,IAPoD,CAA3D,CASH,CAtHE,CA0HV,CA9HK,CAAN","sourcesContent":["/*\n * @package    local_teameval\n * @copyright  2015 Morgan Harris\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n /**\n  * Submit questionnaire button for teameval blocks\n  * @module local_teameval/submitquestion\n  */\ndefine(['jquery', 'core/templates', 'core/ajax', 'core/notification', 'core/str'], function($, Templates, Ajax, Notification, Str) {\n\n    var _cmid;\n\n    return {\n\n        submit: function() {\n\n            var incompletes = 0;\n\n            $('.local-teameval-submit-buttons .submit').prop('disabled', true);\n\n            // These promises resolve to objects with question, ajaxCall and deferred properties\n            // This allows submit methods to return their AJAX call data asynchronously if necessary\n            var questions = $('#local-teameval-questions').find('.question-container').map(function() {\n                return $(this).data('question');\n            });\n\n            // Optional questions first, so the questionnaire doesn't lock halfway through saving\n            questions.sort(function(a, b) {\n                return parseInt(b.optional) - parseInt(a.optional);\n            });\n\n            var questionPromises = questions.map(function() {\n                var p = $.Deferred();\n\n                var complete = this.submit(function(args) {\n                    var d = $.Deferred();\n\n                    if (args && args.methodname) {\n                        p.resolve({\n                            question: this,\n                            ajaxCall: args,\n                            deferred: d\n                        });\n                    } else {\n                        p.resolve();\n                        d.resolve();\n                    }\n\n                    return d.promise();\n                });\n\n                if (! complete) {\n                    incompletes++;\n                }\n\n                return p;\n\n            });\n\n            $.when.apply($, questionPromises).done(function() {\n\n                var questions = [].slice.call(arguments).filter(function(v) { return v !== undefined; });\n\n                // Add the completed call\n                var allDone = $.Deferred();\n                questions.push({\n                    ajaxCall: {\n                        methodname: \"local_teameval_questionnaire_submitted\",\n                        args: {\n                            cmid: _cmid\n                        }\n                    },\n                    deferred: allDone\n                });\n\n                var promises = Ajax.call(questions.map(function(v) { return v.ajaxCall; }));\n\n                for (var i = 0; i < questions.length; i++) {\n                    var p = promises[i];\n                    var d = questions[i].deferred;\n                    p.done(d.resolve);\n                    p.fail(d.reject);\n                    p.progress(d.notify);\n                }\n\n                var allPromises = $.when.apply($, promises);\n                allPromises.always(function() {\n                    $('.local-teameval-submit-buttons .submit').prop('disabled', false);\n                }).done(function() {\n                    if (incompletes > 0) {\n                        var key = incompletes == 1 ? 'incompletewarning1' : 'incompletewarning';\n                        Str.get_string(key, 'local_teameval', incompletes)\n                            .done(function(string) {\n                            $('.local-teameval-submit-buttons .results.incomplete').text(string).show('fast');\n                        });\n                    } else {\n                        $('.local-teameval-submit-buttons .results.incomplete').hide('fast');\n                        $('.local-teameval-submit-buttons .results.saved').show('fast').delay(5000).hide('fast');\n                    }\n                }).fail(Notification.exception);\n\n            });\n\n        },\n\n        reset: function() {\n            var questions = $('#local-teameval-questions').find('.question-container').map(function() {\n                return $(this).data('question');\n            });\n\n            $.when(questions.map(function() { return this.reset(); }))\n            .done(function() {\n                // Do nothing\n            })\n            .fail(Notification.exception);\n        },\n\n        initialise: function(cmid) {\n\n            _cmid = cmid;\n\n            Templates.render('local_teameval/submit_buttons', {}).done(function(html, js) {\n                var questionContainer = $('.local-teameval-containerbox');\n                questionContainer.append(html);\n                Templates.runTemplateJS(js);\n\n                $('.local-teameval-submit-buttons .submit').click(this.submit);\n                $('.local-teameval-submit-buttons .reset').click(this.reset);\n            }.bind(this));\n\n        }\n\n    };\n\n});\n"],"file":"submitquestion.min.js"}