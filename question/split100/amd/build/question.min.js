define ("teamevalquestion_split100/question",["local_teameval/question","jquery","core/str","local_teameval/formparse","local_teameval/editor"],function(a,b,c,d,e){function f(a,c){return a.reduce(function(d,a,b){if(b>=c){return d}return d+a},0)}function g(a,b){var c=100/(100-5*b);return c*a-5*c}function h(a,b){var c=100/(100-5*b);return(a+5*c)/c}function j(a,c){var d=a.map(function(a){return Math.round(a)});c=c||[];var e=f(d);if(100!=e){var g=e-100,h=a.map(function(a,b){return{i:b,v:a}}),j=0>g?1:-1;h.sort(function(e,a){var b=-1!=c.indexOf(e.i),f=-1!=c.indexOf(a.i);if(b!=f){return b?-1:1}return Math.abs(d[e.i]+j-e.v)-Math.abs(d[a.i]+j-a.v)});for(var k=0,b;k<Math.abs(g);k++){b=h[k].i;d[b]+=j}}return d}function k(c,d,e,f,g,h,i,j){a.apply(this,arguments);this.self=f;this.context=j||{};this.pluginName="split100";if(this.container.find(".hundred").length){this.updateView();this.initialiseSubmissionView()}b(window).on("resize",function(){this.updateView()}.bind(this))}k.prototype=Object.create(a.prototype);k.prototype.displayToReal=function(a){return g(a,this.sizes.length)};k.prototype.realToDisplay=function(a){return h(a,this.sizes.length)};k.prototype.showOverflow=function(a){var b=this.container.find(".overflows").children(".name").eq(a),c=this.container.find(".hundred").children(".split").eq(a);b.show();var d=c.position().left+c.width()/2,e=b.find("span").width()+20,f=this.container.find(".hundred").width(),g=d<f/2?["left","right"]:["right","left"],h=[];if(d+e<f){h.push("left")}if(0<d-e){h.push("right")}b.removeClass("left right middle");b.css("margin-left","");b.css("margin-right","");for(var j=0,k;j<g.length;j++){k=g[j];if(-1!==h.indexOf(k)){b.addClass(k);b.css("z-index",100-a);switch(k){case"left":b.css("left",d-10+"px");break;case"right":b.css("right",f-d+"px");break;}break}}};k.prototype.updateView=function(a){if(!this.context){return}var c=this.context.users.length;if(!this.sizes){this.sizes=this.context.users.map(function(a){return h(parseFloat(a.pct),c)},this)}var d=this.container.find(".hundred");if(0===d.length){return}this.sizes=this.sizes.map(function(a){return Math.max(a,5)});var e=f(this.sizes),g=this.sizes.map(this.displayToReal,this);if(100!=e){var k=f(g);g=g.map(function(a){return a*(100/k)});this.sizes=g.map(this.realToDisplay,this)}for(var l=j(g,a),m=d.children(".split"),n=d.children(".handle"),o=0,p=0,q;p<this.sizes.length;p++){q=this.sizes[p];m.eq(p).css({width:q+"%",left:o+"%"}).find(".name").show().end().find(".value").html(l[p]+"%");o+=q;n.eq(p).css("left",o+"%");var r=m.get(p);if(r.scrollWidth>r.clientWidth||r.scrollHeight>r.clientHeight){b(r).find(".split-label .name").hide();this.showOverflow(p)}else{this.container.find(".overflows").children(".name").eq(p).hide()}}};k.prototype.initialiseSubmissionView=function(){var a,c,d,e,g,h=this.container.find(".hundred");if(window.TouchEvent){this.container.find(".handle").addClass("touch")}h.on("mousedown touchstart",".handle",function(f){if(!a){f.preventDefault();a=b(f.target);e=b(f.delegateTarget).children(".handle").index(a);c=b(f.delegateTarget).offset();d=b(f.delegateTarget).width();if(f.originalEvent.touches){g=f.originalEvent.touches[0].identifier}if(-1==e){throw"The DOM tree is messed up; reload the page"}}}).on("mousemove touchmove",function(b){if(a){b.preventDefault();var h;if(b.pageX){h=b.pageX}else if(b.originalEvent.touches){for(var j=0,k;j<b.originalEvent.changedTouches.length;j++){k=b.originalEvent.changedTouches[j];if(k.identifier==g){h=k.pageX}}}if(h===void 0){return}var l=100*((h-c.left)/d),m=f(this.sizes,e+1),n=l-m,o=e,p=e+1;if(0>n){o=null;for(var j=e;0<=j;j--){if(this.sizes[j]>5){o=j;break}}}if(0<n){p=null;for(var j=e+1;j<this.sizes.length;j++){if(this.sizes[j]>5){p=j;break}}}if(null!==o&&null!==p){this.sizes[o]+=n;this.sizes[p]-=n}this.updateView([o,p])}}.bind(this)).on("mouseup mouseleave touchend touchcancel",function(b){b.preventDefault();a=null;h.children(".split").css("color","")})};k.prototype.submissionView=function(){return a.prototype.submissionView.apply(this,arguments).done(function(){this.updateView();this.initialiseSubmissionView()}.bind(this))};k.prototype.submissionContext=function(){return this.context};k.prototype.editingView=function(){var a={title:this.context.title,description:{format:1,text:this.context.description}};return this.editForm("\\teamevalquestion_split100\\forms\\edit_form",b.param(a),{})};k.prototype.save=function(a){var f=this.container.find("form");e.saveAll(f);var g=d.serializeObject(f);this.context.title=g.title;this.context.description=g.description.text;var h=[this.self?"yourself":"exampleuser","exampleuser","exampleuser","exampleuser"].map(function(a,b){return{key:a,component:"teamevalquestion_split100",param:this.self?b:b+1}},this),i=c.get_strings(h).then(function(a){var b=[20,10,15,55],c=[21,13,17,49],d=[0,21,34,51];this.context.users=a.map(function(a,e){return{name:a,id:-e,pct:b[e],width:c[e],left:d[e],rounded:b[e],first:0===e,self:this.self?0===e:!1}}.bind(this))}.bind(this)),j=this.saveForm(f,a);return b.when(j,i)};k.prototype.submit=function(a){if(!this.sizes){a();return!0}for(var b=[],c=this.context.users.length-1;0<=c;c--){var d=this.context.users[c],e=this.sizes[c];d.pct=this.displayToReal(e);b.push({userid:d.id,pct:d.pct})}var f={teamevalid:this.teameval,questionid:this.questionID,percents:b};a({methodname:"teamevalquestion_split100_submit_response",args:f});return!0};k.prototype.reset=function(){for(var a=100/this.context.users.length,c=this.context.users.length-1,d;0<=c;c--){d=this.context.users[c];d.pct=a}this.sizes=void 0;this.updateView();return b.Deferred().resolve().promise()};return k});
//# sourceMappingURL=question.min.js.map
